-- ==================== AUTO PARTY MODULE ====================
-- Load t·ª´: https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/autoparty.lua
-- Y√™u c·∫ßu: WindUI, c√°c bi·∫øn global t·ª´ file ch√≠nh
-- ===========================================================

local Module = {}

-- ‚úÖ L·∫•y c√°c bi·∫øn c·∫ßn thi·∫øt t·ª´ file ch√≠nh
local WindUI = _G.WindUI
local Window = _G.Window
local c = _G.PlayerLocal
local d = _G.UserId
local e = _G.HttpService
local a6 = _G.TeleportService
local aC = _G.CurrentDungeon
local ay = _G.CurrentDungeonId
local az = _G.CurrentDifficulty
local ce = _G.DungeonsList
local cc = _G.WorldsList
local ToggleStates = _G.ToggleStates
local Toggles = _G.Toggles
local ConfigSystem = _G.ConfigSystem
local a5 = game:GetService("ReplicatedStorage"):WaitForChild('Shared')

-- ‚úÖ PERSISTENT DATA (GI·ªêNG anya.lua) - ƒê·ªÇ ƒê·ªíNG B·ªò V·ªöI H·ªÜ TH·ªêNG REJOIN C≈®
local ao = {
    PartyRejoinDungeon = false,     -- Flag ƒë·ªÉ party rejoin dungeon
    PartyDungeonJobId = nil,        -- JobId dungeon ƒë·ªÉ rejoin
    PartyDungeonPlaceId = nil,      -- PlaceId dungeon
    PartyDungeonId = nil,           -- ‚úÖ TH√äM: DungeonId ƒë·ªÉ StartRaid
    PartyDifficulty = nil,          -- ‚úÖ TH√äM: Difficulty ƒë·ªÉ StartRaid
    PartyTimestamp = 0,             -- Timestamp l∆∞u
    PartyThreshold = 600            -- 10 ph√∫t timeout
}
-- ‚úÖ ƒê·ªîI: FILE CHUNG CHO C·∫¢ PARTY (KH√îNG D√ôNG UserId)
local partyDataFile = 'AnyaHub_PartyDungeonData.txt'

-- ==================== GLOBALS ====================
-- ‚úÖ H√ÄM SAVE/LOAD PARTY DUNGEON DATA
local function savePartyData()
    if not writefile then return end
    pcall(function()
        writefile(partyDataFile, e:JSONEncode(ao))
    end)
end

local function loadPartyData()
    if not (readfile and isfile and isfile(partyDataFile)) then return false end
    local success = pcall(function()
        ao = e:JSONDecode(readfile(partyDataFile))
    end)
    return success
end

local PartyGlobals = {
    PartySetup = { Leader = "", Members = {"", "", "", "", ""} },
    isMonitoringParty = false,
    isLoadingPartyConfig = false,
    isInitializingUI = true,
    globalInviteCooldown = {},
    GLOBAL_INVITE_COOLDOWN = 30,
    PartyConfigFile = "AnyaHub_PartyConfig_" .. c.Name .. ".txt",
    -- ‚úÖ TH√äM: L∆∞u JobId chung cho c·∫£ team
    SharedRejoinJobId = nil,
    SharedRejoinPlaceId = nil,
    SharedRejoinFile = 'AnyaHub_PartySharedRejoin.txt',
    DungeonRejoinFile = 'AnyaHub_DungeonRejoin.txt',
    PartyCheckDelay = 10,
    LastDungeonJobId = nil,
    LastDungeonPlaceId = nil
}

local SharedJobIdSystem = {
    CurrentJobId = nil,
    LastUpdateTime = 0,
    UpdateInterval = 5,
    FilePath = d .. '_SharedJobId.txt',
    InDungeon = false,
    LastDungeonInfo = nil,
    
    WorldJobIdCache = {},
    LastScanTime = 0,
    ScanInterval = 300,
    IsScanning = false,
    
    -- ‚úÖ DANH S√ÅCH T·∫§T C·∫¢ WORLDS V√Ä KHU V·ª∞C H·ª¢P L·ªÜ
    ValidWorlds = {
        {PlaceId = 4310463616, Name = 'World 1'},
        {PlaceId = 4310463940, Name = 'World 2'},
        {PlaceId = 4465987684, Name = 'World 3'},
        {PlaceId = 4646472003, Name = 'World 4'},
        {PlaceId = 5703355191, Name = 'World 5'},
        {PlaceId = 6075083204, Name = 'World 6'},
        {PlaceId = 6847035264, Name = 'World 7'},
        {PlaceId = 9944262922, Name = 'World 8'},
        {PlaceId = 10651517727, Name = 'World 9'},
        {PlaceId = 14914684761, Name = 'World 10'},
        {PlaceId = 6510868181, Name = 'PvpArena'},
        {PlaceId = 7499964980, Name = 'Marketplace'}
    }
}

-- ==================== SHARED JOB ID SYSTEM ====================
function SharedJobIdSystem:GetRequestFunction()
    return (syn and syn.request) or 
           (http and http.request) or 
           (http_request) or 
           (fluxus and fluxus.request) or
           request
end

-- ‚úÖ H√ÄM L·∫§Y JOBID T·ª™ API
function SharedJobIdSystem:GetMarketplaceJobIdFromAPI()
    local requestFunc = self:GetRequestFunction()
    
    if not requestFunc then
        warn("‚ùå Executor kh√¥ng h·ªó tr·ª£ HTTP request")
        return nil
    end
    
    local success, result = pcall(function()
        local response = requestFunc({
            Url = "https://web-production-d07d6.up.railway.app/api/jobid",
            Method = "GET"
        })
        
        if response and response.StatusCode == 200 and response.Body then
            local jobId = response.Body:match("^%s*(.-)%s*$") -- Trim whitespace
            if jobId and jobId ~= "" and #jobId > 10 then
                warn("‚úÖ [API] Nh·∫≠n ƒë∆∞·ª£c JobId:", jobId:sub(1, 20))
                return jobId
            else
                warn("‚ùå [API] JobId kh√¥ng h·ª£p l·ªá:", tostring(jobId))
                return nil
            end
        else
            warn("‚ùå [API] Response kh√¥ng h·ª£p l·ªá - StatusCode:", response and response.StatusCode or "nil")
            return nil
        end
    end)
    
    if success and result and result ~= "" then
        return result
    else
        warn("‚ùå [API] L·ªói khi g·ªçi API:", tostring(result))
        return nil
    end
end

function SharedJobIdSystem:ScanPlaceJobIds(placeId, maxServers)
    maxServers = maxServers or 100
    local requestFunc = self:GetRequestFunction()
    
    if not requestFunc then
        warn("‚ùå Executor kh√¥ng h·ªó tr·ª£ HTTP request")
        return {}
    end
    
    local jobIds = {}
    local cursor = nil
    local totalScanned = 0 -- ‚úÖ ƒê·∫øm t·ªïng s·ªë servers ƒë√£ qu√©t (k·ªÉ c·∫£ servers ƒë·∫ßy)
    local foundCount = 0 -- ‚úÖ ƒê·∫øm s·ªë servers c√≥ ch·ªó tr·ªëng
    
    pcall(function()
        repeat
            local url = string.format(
                "https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=Asc&limit=100%s",
                placeId,
                cursor and ("&cursor=" .. cursor) or ""
            )
            
            local response = requestFunc({Url = url, Method = "GET"})
            
            if response and response.Body then
                local data = e:JSONDecode(response.Body)
                
                if data and data.data then
                    for _, server in ipairs(data.data) do
                        totalScanned = totalScanned + 1
                        
                        -- ‚úÖ L∆ØU T·∫§T C·∫¢ SERVERS (K·ªÇ C·∫¢ SERVERS ƒê·∫¶Y)
                        table.insert(jobIds, {
                            JobId = server.id,
                            Players = server.playing,
                            MaxPlayers = server.maxPlayers
                        })
                        foundCount = foundCount + 1
                        
                        -- ‚úÖ D·ª™NG KHI ƒê·ª¶ S·ªê L∆Ø·ª¢NG C·∫¶N T√åM
                        if foundCount >= maxServers then
                            warn("‚úÖ ƒê√£ t√¨m ƒë·ªß", maxServers, "servers, d·ª´ng scan")
                            cursor = nil
                            break
                        end
                    end
                end
                
                cursor = data.nextPageCursor
            else
                warn("‚ùå Kh√¥ng nh·∫≠n ƒë∆∞·ª£c response t·ª´ Roblox API")
                break
            end
            
            task.wait(0.1) -- ‚úÖ Gi·∫£m delay xu·ªëng 0.1s ƒë·ªÉ nhanh h∆°n
        until not cursor
    end)
    
    warn("‚úÖ T·ªïng c·ªông t√¨m th·∫•y", #jobIds, "servers (Qu√©t:", totalScanned, "servers)")
    return jobIds
end
function SharedJobIdSystem:ScanAllWorlds()
    if self.IsScanning then
        warn("‚ö†Ô∏è ƒêang scan, b·ªè qua")
        return
    end
    
    self.IsScanning = true
    warn("üîç B·∫Øt ƒë·∫ßu scan JobId World 1...")
    
    task.spawn(function()
        -- ‚úÖ CH·ªà SCAN WORLD 1 TH√îI
        local world1PlaceId = 4310463616
        
        pcall(function()
            warn("üì° Scanning World 1...")
            
            local jobIds = self:ScanPlaceJobIds(world1PlaceId, 50)
            
            if #jobIds > 0 then
                self.WorldJobIdCache[world1PlaceId] = {
                    Name = "World 1",
                    JobIds = jobIds,
                    LastUpdate = tick()
                }
                warn("‚úÖ World 1 - T√¨m th·∫•y", #jobIds, "servers")
            else
                warn("‚ö†Ô∏è World 1 - Kh√¥ng t√¨m th·∫•y server ph√π h·ª£p")
            end
        end)
        
        self.LastScanTime = tick()
        self.IsScanning = false
        warn("‚úÖ Scan ho√†n t·∫•t!")
        
        self:SaveJobIdCache()
    end)
end
function SharedJobIdSystem:SaveJobIdCache()
    if not writefile then return end
    
    local cacheFile = d .. '_WorldJobIdCache.txt'
    
    pcall(function()
        local data = {
            Cache = self.WorldJobIdCache,
            LastScanTime = self.LastScanTime
        }
        writefile(cacheFile, e:JSONEncode(data))
        warn("üíæ ƒê√£ l∆∞u JobId cache")
    end)
end

function SharedJobIdSystem:LoadJobIdCache()
    if not (readfile and isfile) then return false end
    
    local cacheFile = d .. '_WorldJobIdCache.txt'
    
    if not isfile(cacheFile) then return false end
    
    local success = pcall(function()
        local content = readfile(cacheFile)
        local data = e:JSONDecode(content)
        
        if data then
            self.WorldJobIdCache = data.Cache or {}
            self.LastScanTime = data.LastScanTime or 0
            
            if tick() - self.LastScanTime > 1800 then
                warn("‚ö†Ô∏è Cache qu√° c≈©")
                return false
            end
            
            warn("üìÇ Loaded JobId cache - Age:", math.floor(tick() - self.LastScanTime), "gi√¢y")
            return true
        end
    end)
    
    return success
end

function SharedJobIdSystem:GetWorld1JobId()
    local world1PlaceId = 4310463616
    local data = self.WorldJobIdCache[world1PlaceId]
    
    if data and data.JobIds and #data.JobIds > 0 then
        local randomJobId = data.JobIds[math.random(1, #data.JobIds)]
        
        return {
            PlaceId = world1PlaceId,
            Name = "World 1",
            JobId = randomJobId.JobId,
            Players = randomJobId.Players
        }
    end
    
    warn("‚ùå Kh√¥ng c√≥ World 1 trong cache")
    return nil
end

function SharedJobIdSystem:SaveJobId(jobId, dungeonInfo)
    if not writefile then return end
    
    local data = {
        JobId = jobId,
        Timestamp = tick(),
        PlaceId = game.PlaceId,
        DungeonInfo = dungeonInfo or self.LastDungeonInfo
    }
    
    pcall(function()
        writefile(self.FilePath, e:JSONEncode(data))
    end)
end

function SharedJobIdSystem:LoadJobId()
    if not (readfile and isfile and isfile(self.FilePath)) then 
        return nil 
    end
    
    local success, result = pcall(function()
        local content = readfile(self.FilePath)
        local data = e:JSONDecode(content)
        
        local timeDiff = tick() - (data.Timestamp or 0)
        if timeDiff > 900 then
            return nil
        end
        
        return data
    end)
    
    return success and result or nil
end

function SharedJobIdSystem:ClearJobId()
    if not writefile then return end
    pcall(function()
        writefile(self.FilePath, "")
    end)
end

function SharedJobIdSystem:GetCurrentJobId()
    return game.JobId
end

function SharedJobIdSystem:GetCurrentDungeonInfo()
    if not aC then return nil end
    
    for _, dungeonData in ipairs(ce) do
        if dungeonData.Id == ay then
            return {
                Id = dungeonData.Id,
                Name = dungeonData.Name,
                Difficulty = az,
                Code = dungeonData.Code
            }
        end
    end
    
    return nil
end

function SharedJobIdSystem:UpdateJobId()
    local currentJobId = self:GetCurrentJobId()
    
    if aC then
        self.InDungeon = true
        self.LastDungeonInfo = self:GetCurrentDungeonInfo()
        
        if Toggles.AutoPartyMonitor and Toggles.AutoPartyMonitor.Value then
            local timeSinceLastScan = tick() - self.LastScanTime
            
            if timeSinceLastScan >= self.ScanInterval and not self.IsScanning then
                self:ScanAllWorlds()
            end
        end
    end
    
    if currentJobId ~= self.CurrentJobId then
        self.CurrentJobId = currentJobId
        self.LastUpdateTime = tick()
        self:SaveJobId(currentJobId, self.LastDungeonInfo)
    end
end

function SharedJobIdSystem:StartMonitoring()
    self:LoadJobIdCache()
    
    task.spawn(function()
        while task.wait(self.UpdateInterval) do
            pcall(function()
                self:UpdateJobId()
            end)
        end
    end)
end

function SharedJobIdSystem:TeleportToPlace(targetPlaceId, targetJobId)
    if not targetJobId or targetJobId == "" then
        return false
    end
    
    pcall(function()
        a6:TeleportToPlaceInstance(targetPlaceId, targetJobId, c)
    end)
    
    return true
end

-- ==================== PARTY FUNCTIONS ====================
local function timeElapsed(seconds)
    local mins = math.floor(seconds / 60)
    local secs = seconds % 60
    return string.format("%dm %ds", mins, secs)
end

local function getPlayersList()
    local players = {}
    for _, player in ipairs(game:GetService("Players"):GetPlayers()) do
        table.insert(players, player.Name)
    end
    table.sort(players)
    return players
end

local function isLeader() 
    return PartyGlobals.PartySetup.Leader == c.Name 
end

-- ‚úÖ KI·ªÇM TRA C√ì ƒêANG ·ªû MARKETPLACE HO·∫∂C WORLD 1 KH√îNG (DO C√ì FALLBACK)
local function isInMarketplace()
    return game.PlaceId == 7499964980 or game.PlaceId == 4310463616
end

-- ‚úÖ KI·ªÇM TRA C√ì ƒêANG TRONG DUNGEON KH√îNG
local function isInDungeon()
    return aC ~= nil
end

-- ‚úÖ KI·ªÇM TRA C√ì ƒêANG ·ªû C√ÅC WORLD/PVP/MARKETPLACE H·ª¢P L·ªÜ KH√îNG
local function isInValidWorld()
    local currentPlaceId = game.PlaceId
    for _, world in ipairs(SharedJobIdSystem.ValidWorlds) do
        if world.PlaceId == currentPlaceId then
            return true
        end
    end
    return false
end

local function getMyPartyId()
    local success, partyId = pcall(function()
        local Parties = game:GetService("ReplicatedStorage"):FindFirstChild("Parties")
        if not Parties then 
            return nil 
        end
        
        for _, party in ipairs(Parties:GetChildren()) do
            local Members = party:FindFirstChild("Members")
            if Members then
                for _, memberFolder in ipairs(Members:GetChildren()) do
                    if memberFolder.Name == c.Name then
                        return party.Name
                    end
                end
            end
        end
        
        return nil
    end)
    
    return success and partyId or nil
end

local function isInParty(playerName)
    local partyId = getMyPartyId()
    if not partyId then 
        return false 
    end
    
    local success, result = pcall(function()
        local Parties = game:GetService("ReplicatedStorage"):FindFirstChild("Parties")
        if not Parties then 
            return false 
        end
        
        local myParty = Parties:FindFirstChild(partyId)
        if not myParty then 
            return false 
        end
        
        local Members = myParty:FindFirstChild("Members")
        if not Members then 
            return false 
        end
        
        return Members:FindFirstChild(playerName) ~= nil
    end)
    
    return success and result or false
end

local function getCurrentPartyMemberCount()
    local partyId = getMyPartyId()
    if not partyId then return 0 end
    
    local success, count = pcall(function()
        local Parties = game:GetService("ReplicatedStorage"):FindFirstChild("Parties")
        if not Parties then return 0 end
        
        local myParty = Parties:FindFirstChild(partyId)
        if not myParty then return 0 end
        
        local Members = myParty:FindFirstChild("Members")
        if not Members then return 0 end
        
        return #Members:GetChildren()
    end)
    
    return success and count or 0
end

-- ‚úÖ H√ÄM ƒê·∫æM CH√çNH X√ÅC: ƒê·∫øm t·∫•t c·∫£ ng∆∞·ªùi c·∫ßn c√≥ trong party
local function getExpectedPartySize()
    local count = 1 -- Leader
    for _, memberName in ipairs(PartyGlobals.PartySetup.Members) do
        if memberName ~= "" then
            count = count + 1
        end
    end
    return count
end

-- ‚úÖ ƒê·∫æM S·ªê L∆Ø·ª¢NG MEMBER ƒêANG ONLINE
local function getOnlineMembersCount()
    local count = 0
    
    -- ƒê·∫øm Leader n·∫øu online
    if PartyGlobals.PartySetup.Leader ~= "" then
        if game:GetService("Players"):FindFirstChild(PartyGlobals.PartySetup.Leader) then
            count = count + 1
        end
    end
    
    -- ƒê·∫øm Members n·∫øu online
    for _, memberName in ipairs(PartyGlobals.PartySetup.Members) do
        if memberName ~= "" then
            if game:GetService("Players"):FindFirstChild(memberName) then
                count = count + 1
            end
        end
    end
    
    return count
end

-- ‚úÖ KI·ªÇM TRA T·∫§T C·∫¢ MEMBERS C√ì ONLINE KH√îNG
local function areAllMembersOnline()
    -- Ki·ªÉm tra Leader
    if PartyGlobals.PartySetup.Leader ~= "" then
        if not game:GetService("Players"):FindFirstChild(PartyGlobals.PartySetup.Leader) then
            return false
        end
    end
    
    -- Ki·ªÉm tra Members
    for _, memberName in ipairs(PartyGlobals.PartySetup.Members) do
        if memberName ~= "" then
            if not game:GetService("Players"):FindFirstChild(memberName) then
                return false
            end
        end
    end
    
    return true
end

local function inviteMember(playerName)
    local currentTime = tick()
    local lastInvited = PartyGlobals.globalInviteCooldown[playerName] or 0
    local timeSinceInvite = currentTime - lastInvited
    
    if timeSinceInvite < PartyGlobals.GLOBAL_INVITE_COOLDOWN then
        warn("‚è≥ Invite cooldown active for", playerName)
        return
    end
    
    pcall(function()
        local player = game:GetService("Players"):FindFirstChild(playerName)
        if player then
            game:GetService("ReplicatedStorage").Shared.Party.Invite:FireServer(player)
            PartyGlobals.globalInviteCooldown[playerName] = currentTime
            warn("üì§ Sent Invite to:", playerName)
            WindUI:Notify({
                Title = "Party Invite",
                Content = "üì§ Invited " .. playerName,
                Duration = 2
            })
        end
    end)
end

local function acceptInvite(fromPlayer)
    pcall(function()
        local args = {
            [1] = game:GetService("Players"):WaitForChild(fromPlayer)
        }
        
        game:GetService("ReplicatedStorage"):WaitForChild("Shared"):WaitForChild("Party"):WaitForChild("AcceptedInvite"):FireServer(unpack(args))
        
        warn("‚úÖ Accepted invite from:", fromPlayer)
        WindUI:Notify({
            Title = "Party Invite",
            Content = "‚úÖ Accepted from " .. fromPlayer,
            Duration = 2
        })
    end)
end

local function getMembersToInvite()
    local toInvite = {}
    for _, memberName in ipairs(PartyGlobals.PartySetup.Members) do
        if memberName ~= "" and memberName ~= c.Name then
            table.insert(toInvite, memberName)
        end
    end
    return toInvite
end

local function getMissingMembers()
    local missing = {}
    for _, memberName in ipairs(getMembersToInvite()) do
        if not isInParty(memberName) then
            table.insert(missing, memberName)
        end
    end
    return missing
end

-- ‚úÖ L·∫§Y JOBID T·ª™ API (C√ì FALLBACK V·ªÄ WORLD 1 N·∫æU API FAIL)
local function getMarketplaceJobId()
    -- Th·ª≠ l·∫•y t·ª´ API tr∆∞·ªõc
    local jobId = SharedJobIdSystem:GetMarketplaceJobIdFromAPI()
    if jobId and jobId ~= "" then
        PartyGlobals.SharedRejoinPlaceId = 7499964980
        PartyGlobals.SharedRejoinJobId = jobId
        warn("‚úÖ [API] PlaceId: 7499964980, JobId:", jobId:sub(1,20))
        return jobId
    else
        warn("‚ö†Ô∏è [API] Kh√¥ng l·∫•y ƒë∆∞·ª£c JobId t·ª´ API, fallback v·ªÅ World 1")
        
        -- Fallback: D√πng World 1 nh∆∞ code c≈©
        local world1Server = SharedJobIdSystem:GetWorld1JobId()
        if world1Server and world1Server.JobId then
            PartyGlobals.SharedRejoinPlaceId = 4310463616
            PartyGlobals.SharedRejoinJobId = world1Server.JobId
            warn("‚úÖ [FALLBACK] PlaceId: 4310463616, JobId:", world1Server.JobId:sub(1,20))
            return world1Server.JobId
        else
            warn("‚ùå [FALLBACK] Kh√¥ng c√≥ JobId - C·∫ßn scan World 1")
            SharedJobIdSystem:ScanAllWorlds()
            return nil
        end
    end
end

-- ‚úÖ L∆ØU DUNGEON JOBID ƒê·ªÇ QUAY L·∫†I
local function saveDungeonJobId()
    if not (writefile and aC) then return end
    
    pcall(function()
        local data = {
            PlaceId = game.PlaceId,
            JobId = game.JobId,
            Timestamp = tick(),
            DungeonId = ay,
            Difficulty = az
        }
        writefile(PartyGlobals.DungeonRejoinFile, e:JSONEncode(data))
        PartyGlobals.LastDungeonJobId = game.JobId
        PartyGlobals.LastDungeonPlaceId = game.PlaceId
        warn("üíæ [DUNGEON] ƒê√£ l∆∞u Dungeon JobId:", game.JobId:sub(1,20))
    end)
end

-- ‚úÖ T·∫¢I DUNGEON JOBID
local function loadDungeonJobId()
    if not (readfile and isfile and isfile(PartyGlobals.DungeonRejoinFile)) then 
        return nil 
    end
    
    local success, result = pcall(function()
        local content = readfile(PartyGlobals.DungeonRejoinFile)
        local data = e:JSONDecode(content)
        
        local timeDiff = tick() - (data.Timestamp or 0)
        if timeDiff > 600 then -- 10 ph√∫t
            return nil
        end
        
        PartyGlobals.LastDungeonJobId = data.JobId
        PartyGlobals.LastDungeonPlaceId = data.PlaceId
        
        warn("‚úÖ [DUNGEON] ƒê√£ t·∫£i Dungeon JobId:", data.JobId:sub(1,20))
        return data
    end)
    
    return success and result or nil
end

-- ‚úÖ S·ª¨A L·∫†I PARTY MONITORING - T√çCH H·ª¢P V·ªöI REJOIN DUNGEON
local function startPartyMonitoring()
    if PartyGlobals.isMonitoringParty then 
        warn("‚ö†Ô∏è Party monitoring already active")
        return 
    end
    
    PartyGlobals.isMonitoringParty = true
    warn("‚úÖ Started party monitoring")
    
    -- ‚úÖ Load party data t·ª´ file
    loadPartyData()
    
    -- ‚úÖ N·∫æU ƒêANG TRONG DUNGEON ‚Üí L∆ØU JOBID + DUNGEONID + DIFFICULTY
    if aC then
        warn("üîç ƒêang trong dungeon - L∆∞u th√¥ng tin ƒë·∫ßy ƒë·ªß...")
        ao.PartyRejoinDungeon = true
        ao.PartyDungeonJobId = game.JobId
        ao.PartyDungeonPlaceId = game.PlaceId
        ao.PartyDungeonId = ay  -- ‚úÖ L∆∞u dungeonId
        ao.PartyDifficulty = az -- ‚úÖ L∆∞u difficulty
        ao.PartyTimestamp = tick()
        savePartyData()
        warn("üíæ ƒê√£ l∆∞u: DungeonId=", ay, "Difficulty=", az)
    end
    
    local rejoinAttempts = 0
    local lastRejoinTime = 0
    
task.spawn(function()
        while Toggles.AutoPartyMonitor and Toggles.AutoPartyMonitor.Value do
            -- ‚úÖ B∆Ø·ªöC 1: CH·ªà KI·ªÇM TRA TELEPORT KHI ·ªû C√ÅC WORLD H·ª¢P L·ªÜ (KH√îNG PH·∫¢I DUNGEON)
            if isInValidWorld() and not isInMarketplace() then
                warn("‚ö†Ô∏è ƒêang ·ªü World/PvP kh√°c (PlaceId:", game.PlaceId, ") ‚Üí Chu·∫©n b·ªã teleport v·ªÅ Marketplace/World 1")
                
                local targetJobId = getMarketplaceJobId()
                local targetPlaceId = PartyGlobals.SharedRejoinPlaceId or 7499964980
                
                if targetJobId then
                    -- ‚úÖ KI·ªÇM TRA ƒê√É ·ªû ƒê√öNG JOBID CH∆ØA
                    if game.JobId == targetJobId and game.PlaceId == targetPlaceId then
                        warn("‚úÖ ƒê√£ ·ªü ƒë√∫ng JobId, b·ªè qua teleport")
                    else
                        local placeName = targetPlaceId == 7499964980 and "Marketplace" or "World 1"
                        warn("üåç Teleport v·ªÅ", placeName, "JobId:", targetJobId:sub(1,20))
                        WindUI:Notify({
                            Title = "Auto Party",
                            Content = "üåç ƒêang v·ªÅ " .. placeName .. "...",
                            Duration = 5
                        })
                        task.wait(2)
                        SharedJobIdSystem:TeleportToPlace(targetPlaceId, targetJobId)
                        return
                    end
                else
                    warn("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c JobId, ƒë·ª£i cycle ti·∫øp theo")
                end
            end
            
            -- ‚úÖ KH√îNG C·∫¶N KI·ªÇM TRA JOBID C≈® - API LU√îN TR·∫¢ V·ªÄ JOBID M·ªöI NH·∫§T
            
            -- ‚úÖ ƒê·∫æM CH√çNH X√ÅC - D√ôNG ONLINE COUNT THAY V√å PARTY COUNT
            local expectedTotal = getExpectedPartySize()
            local currentCount = getCurrentPartyMemberCount()
            local onlineCount = getOnlineMembersCount()
            local allOnline = areAllMembersOnline()
            
            warn("üìä Party Status: ", currentCount, "/", expectedTotal, "(Online:", onlineCount, "/", expectedTotal, ")")
            
            -- ‚úÖ KI·ªÇM TRA RESTART DUNGEON TR∆Ø·ªöC KHI L√ÄM G√å KH√ÅC
            if currentCount >= expectedTotal and allOnline and isInMarketplace() then
                warn("‚úÖ Party ƒë·ªß ng∆∞·ªùi + T·∫•t c·∫£ online + ƒêang ·ªü Marketplace")
                
                -- Reload party data ƒë·ªÉ ƒë·ªìng b·ªô
                loadPartyData()
                task.wait(0.5)
                
                if ao.PartyRejoinDungeon and ao.PartyDungeonId and ao.PartyDifficulty then
                    local timeDiff = tick() - ao.PartyTimestamp
                    
                    if timeDiff <= ao.PartyThreshold then
                        warn("üéØ C√≥ dungeon ƒë√£ l∆∞u ‚Üí Chu·∫©n b·ªã restart!")
                        warn("üíæ DungeonId:", ao.PartyDungeonId, "Difficulty:", ao.PartyDifficulty)
                        
                        WindUI:Notify({
                            Title = "Party Ready",
                            Content = "üéØ ƒê·ªß ng∆∞·ªùi! Restart dungeon sau 5 gi√¢y...",
                            Duration = 5
                        })
                        
                        task.wait(5)
                        
                        if isLeader() then
                            warn("üëë LEADER ƒëang restart dungeon via StartRaid")
                            
                            pcall(function()
                                local StartRaid = a5:WaitForChild('Teleport'):WaitForChild('StartRaid')
                                local dungeonId = ao.PartyDungeonId
                                local difficulty = ao.PartyDifficulty
                                
                                warn("üîÑ StartRaid - DungeonId:", dungeonId, "Difficulty:", difficulty)
                                
                                if dungeonId and difficulty then
                                    StartRaid:FireServer(dungeonId, difficulty)
                                    
                                    WindUI:Notify({
                                        Title = "Party Leader",
                                        Content = "üëë LEADER ƒëang restart dungeon...",
                                        Duration = 5
                                    })
                                    
                                    warn("‚úÖ ƒê√£ g·ªçi StartRaid th√†nh c√¥ng!")
                                else
                                    warn("‚ùå DungeonId ho·∫∑c Difficulty b·ªã nil!")
                                end
                            end)
                            
                            task.wait(3)
                            
                            -- Reset state sau khi restart
                            ao.PartyRejoinDungeon = false
                            ao.PartyDungeonJobId = nil
                            ao.PartyDungeonPlaceId = nil
                            ao.PartyDungeonId = nil
                            ao.PartyDifficulty = nil
                            savePartyData()
                            
                            warn("üóëÔ∏è ƒê√£ reset party dungeon state")
                        else
                            warn("üë§ MEMBER ƒë·ª£i LEADER restart dungeon...")
                            
                            WindUI:Notify({
                                Title = "Party Member",
                                Content = "‚è≥ ƒê·ª£i LEADER restart dungeon...",
                                Duration = 5
                            })
                        end
                        
                        -- Ti·∫øp t·ª•c monitoring
                        task.wait(PartyGlobals.PartyCheckDelay)
                        continue
                    else
                        warn("‚ö†Ô∏è Dungeon JobId qu√° c≈© (>10 ph√∫t), b·ªè qua")
                        ao.PartyRejoinDungeon = false
                        ao.PartyDungeonJobId = nil
                        ao.PartyDungeonPlaceId = nil
                        ao.PartyDungeonId = nil
                        ao.PartyDifficulty = nil
                        savePartyData()
                    end
                else
                    warn("‚ÑπÔ∏è Kh√¥ng c√≥ dungeon ƒë√£ l∆∞u ƒë·ªÉ restart")
                end
            end
            
            -- ‚úÖ KI·ªÇM TRA: N·∫æU PARTY ƒê·∫¶Y NH∆ØNG C√ì NG∆Ø·ªúI OFFLINE ‚Üí THO√ÅT PARTY V√Ä REJOIN NGAY
            if currentCount >= expectedTotal and not allOnline then
                warn("üî¥ Party ƒë·ªß ng∆∞·ªùi (", currentCount, "/", expectedTotal, ") nh∆∞ng c√≥ ng∆∞·ªùi offline ‚Üí Tho√°t party v√† rejoin")
                
                -- ‚úÖ THO√ÅT PARTY TR∆Ø·ªöC
                pcall(function()
                    game:GetService("ReplicatedStorage"):WaitForChild("Shared"):WaitForChild("Party"):WaitForChild("LeaveParty"):InvokeServer()
                    warn("‚úÖ ƒê√£ tho√°t party")
                end)
                
                task.wait(2)
                
                -- ‚úÖ REJOIN V·ªÄ MARKETPLACE/WORLD 1
                local targetJobId = getMarketplaceJobId()
                local targetPlaceId = PartyGlobals.SharedRejoinPlaceId or 7499964980
                
                if targetJobId then
                    if game.JobId == targetJobId and game.PlaceId == targetPlaceId then
                        warn("‚úÖ ƒê√£ ·ªü ƒë√∫ng server Marketplace, kh√¥ng c·∫ßn rejoin")
                    else
                        warn("üõí Rejoin v·ªÅ Marketplace - JobId:", targetJobId:sub(1,20))
                        
                        WindUI:Notify({
                            Title = "Member Offline",
                            Content = "üîÑ C√≥ ng∆∞·ªùi disconnect! ƒêang rejoin Marketplace...",
                            Duration = 5
                        })
                        
                        task.wait(2)
                        SharedJobIdSystem:TeleportToPlace(targetPlaceId, targetJobId)
                        return
                    end
                else
                    warn("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c JobId t·ª´ API")
                end
            end
            
            -- ‚úÖ CH·ªà COI NH∆Ø ƒê·ª¶ KHI: C·∫¢ PARTY COUNT V√Ä ONLINE COUNT ƒê·ªÄU ƒê·ª¶
            if currentCount >= expectedTotal and allOnline then
                warn("‚úÖ Party ƒë√£ ƒë·ªß", expectedTotal, "ng∆∞·ªùi v√† t·∫•t c·∫£ ƒë·ªÅu online!")
                rejoinAttempts = 0
                
                -- ‚úÖ N·∫æU ƒêANG ·ªû MARKETPLACE + C√ì DUNGEON ƒê√É L∆ØU + T·∫§T C·∫¢ ƒê·ªÄU ONLINE ‚Üí QUAY L·∫†I DUNGEON
                if isInMarketplace() and allOnline then
                    local dungeonData = loadDungeonJobId()
                    if dungeonData and dungeonData.JobId then
                        warn("üéØ Party ƒë·ªß ng∆∞·ªùi + T·∫•t c·∫£ online + C√≥ dungeon ‚Üí Quay l·∫°i dungeon")
                        
                        WindUI:Notify({
                            Title = "Party Ready",
                            Content = "üéØ ƒê·ªß th√†nh vi√™n! Quay l·∫°i dungeon...",
                            Duration = 5
                        })
                        
                        task.wait(3)
                        SharedJobIdSystem:TeleportToPlace(dungeonData.PlaceId, dungeonData.JobId)
                        return
                    end
                end
            else
                warn("‚ö†Ô∏è Party thi·∫øu", expectedTotal - onlineCount, "ng∆∞·ªùi (d·ª±a tr√™n online count)")
                
                -- ‚úÖ MEMBER: KI·ªÇM TRA THI·∫æU NG∆Ø·ªúI V√Ä X·ª¨ L√ù REJOIN
                if not isLeader() then
                    -- ‚úÖ N·∫æU ƒêANG TRONG DUNGEON V√Ä THI·∫æU NG∆Ø·ªúI ‚Üí L∆ØU STATE V√Ä REJOIN NGAY
                    if aC then
                        warn("üè∞ [MEMBER IN DUNGEON] ƒêang trong dungeon v√† ph√°t hi·ªán thi·∫øu ng∆∞·ªùi!")
                        warn("üè∞ [MEMBER IN DUNGEON] L∆∞u state v√† chu·∫©n b·ªã rejoin...")
                        
                        -- L∆∞u dungeon state
                        ao.PartyRejoinDungeon = true
                        ao.PartyDungeonJobId = game.JobId
                        ao.PartyDungeonPlaceId = game.PlaceId
                        ao.PartyDungeonId = ay
                        ao.PartyDifficulty = az
                        ao.PartyTimestamp = tick()
                        savePartyData()
                        warn("üíæ [MEMBER IN DUNGEON] ƒê√£ l∆∞u: DungeonId=", ay, "Difficulty=", az)
                        
                        -- ƒê·ª£i 3 gi√¢y ƒë·ªÉ x√°c nh·∫≠n
                        task.wait(3)
                        
                        -- L·∫•y JobId t·ª´ API
                        warn("üìÇ [MEMBER IN DUNGEON] ƒêang l·∫•y JobId ƒë·ªÉ rejoin...")
                        local targetJobId = getMarketplaceJobId()
                        local targetPlaceId = PartyGlobals.SharedRejoinPlaceId or 7499964980
                        
                        if targetJobId then
                            warn("‚úÖ [MEMBER IN DUNGEON] ƒê√£ c√≥ JobId t·ª´ API:", targetJobId:sub(1,20))
                            
                            WindUI:Notify({
                                Title = "Missing Party Member",
                                Content = "üîÑ Thi·∫øu ng∆∞·ªùi! ƒêang rejoin v·ªÅ Marketplace...",
                                Duration = 5
                            })
                            
                            task.wait(2)
                            SharedJobIdSystem:TeleportToPlace(targetPlaceId, targetJobId)
                            return
                        else
                            warn("‚ö†Ô∏è [MEMBER IN DUNGEON] Kh√¥ng l·∫•y ƒë∆∞·ª£c JobId t·ª´ API, ƒë·ª£i cycle ti·∫øp theo")
                        end
                    else
                        -- ‚úÖ N·∫æU KH√îNG TRONG DUNGEON ‚Üí KI·ªÇM TRA JOBID
                        warn("üìÇ [MEMBER CHECK] ƒêang ki·ªÉm tra JobId (Kh√¥ng trong dungeon)...")
                        warn("üìÇ [MEMBER CHECK] PlaceId:", game.PlaceId)
                        
                        local expectedJobId = getMarketplaceJobId()
                        
                        if expectedJobId then
                            local currentJobId = game.JobId
                            
                            warn("üîç [MEMBER CHECK] Current JobId:", currentJobId:sub(1,20))
                            warn("üîç [MEMBER CHECK] Expected JobId:", expectedJobId:sub(1,20))
                            
                            if currentJobId ~= expectedJobId and game.PlaceId ~= 7499964980 then
                                warn("‚ùå [MEMBER CHECK] SAI JOBID ho·∫∑c sai PlaceId! ƒêang teleport...")
                                
                                WindUI:Notify({
                                    Title = "Wrong Server",
                                    Content = "üîÑ Sai server! ƒêang rejoin v·ªÅ Marketplace...",
                                    Duration = 5
                                })
                                
                                task.wait(2)
                                SharedJobIdSystem:TeleportToPlace(7499964980, expectedJobId)
                                return
                            else
                                warn("‚úÖ [MEMBER CHECK] ƒê√∫ng JobId r·ªìi!")
                            end
                        else
                            warn("‚ö†Ô∏è [MEMBER CHECK] Kh√¥ng l·∫•y ƒë∆∞·ª£c JobId t·ª´ API")
                        end
                    end
                end
                
                local missingMembers = getMissingMembers()
                local onlineMissingCount = 0
                local offlineMissingCount = 0
                
                for _, memberName in ipairs(missingMembers) do
                    if game:GetService("Players"):FindFirstChild(memberName) then
                        onlineMissingCount = onlineMissingCount + 1
                    else
                        offlineMissingCount = offlineMissingCount + 1
                    end
                end
                
                -- ‚úÖ N·∫æU C√ì NG∆Ø·ªúI OFFLINE (DISCONNECT) ‚Üí REJOIN NGAY (K·ªÇ C·∫¢ KHI ƒêANG TRONG DUNGEON)
                if offlineMissingCount > 0 then
                    warn("üî¥ Ph√°t hi·ªán", offlineMissingCount, "ng∆∞·ªùi disconnect ‚Üí Chu·∫©n b·ªã rejoin")
                    
                    -- ‚úÖ N·∫æU ƒêANG TRONG DUNGEON ‚Üí L∆ØU STATE ƒê·ªÇ REJOIN SAU
                    if aC then
                        warn("üè∞ ƒêang trong dungeon ‚Üí L∆∞u state ƒë·ªÉ rejoin sau khi ƒë·ªß ng∆∞·ªùi")
                        ao.PartyRejoinDungeon = true
                        ao.PartyDungeonJobId = game.JobId
                        ao.PartyDungeonPlaceId = game.PlaceId
                        ao.PartyDungeonId = ay  -- ‚úÖ L∆∞u dungeonId
                        ao.PartyDifficulty = az -- ‚úÖ L∆∞u difficulty
                        ao.PartyTimestamp = tick()
                        savePartyData()
                        warn("üíæ ƒê√£ l∆∞u: DungeonId=", ay, "Difficulty=", az, "JobId=", game.JobId:sub(1,20))
                    end
                    
                    -- ƒê·ª£i 5 gi√¢y ƒë·ªÉ ch·∫Øc ch·∫Øn h·ªç th·ª±c s·ª± disconnect
                    task.wait(5)
                    
                    -- Ki·ªÉm tra l·∫°i
                    local stillOffline = 0
                    for _, memberName in ipairs(missingMembers) do
                        if not game:GetService("Players"):FindFirstChild(memberName) then
                            stillOffline = stillOffline + 1
                        end
                    end
                    
                    if stillOffline > 0 then
                        warn("üîÑ X√°c nh·∫≠n disconnect ‚Üí Rejoin ƒë·ªÉ ƒë√≥n member")
                        
                        local targetJobId = getMarketplaceJobId()
                        local targetPlaceId = PartyGlobals.SharedRejoinPlaceId or 7499964980
                        
                        if targetJobId then
                            -- ‚úÖ KI·ªÇM TRA ƒê√É ·ªû ƒê√öNG JOBID CH∆ØA
                            if game.JobId == targetJobId and game.PlaceId == targetPlaceId then
                                warn("‚úÖ ƒê√£ ·ªü ƒë√∫ng server Marketplace, kh√¥ng c·∫ßn rejoin")
                            else
                                warn("üõí Rejoin v·ªÅ Marketplace - JobId:", targetJobId:sub(1,20))
                                
                                if isLeader() then
                                    WindUI:Notify({
                                        Title = "Member Disconnected",
                                        Content = "üîÑ Rejoin v·ªÅ Marketplace ƒë·ªÉ ƒë·ª£i member...",
                                        Duration = 5
                                    })
                                else
                                    WindUI:Notify({
                                        Title = "Rejoining",
                                        Content = "üîÑ Rejoin v·ªÅ Marketplace...",
                                        Duration = 5
                                    })
                                end
                                
                                task.wait(2)
                                SharedJobIdSystem:TeleportToPlace(targetPlaceId, targetJobId)
                                return
                            end
                        else
                            warn("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c JobId t·ª´ API")
                        end
                    end
                end
                
                -- ‚úÖ N·∫æU C√ì NG∆Ø·ªúI ONLINE NH∆ØNG CH∆ØA V√ÄO PARTY + ƒêANG ·ªû MARKETPLACE
                if onlineMissingCount > 0 and isInMarketplace() then
                    warn("üë• Ng∆∞·ªùi online v√† c√πng server (Marketplace) ‚Üí M·ªùi/Accept")
                    
                    -- ‚úÖ MEMBER: Ki·ªÉm tra c√≥ ƒëang ·ªü party sai kh√¥ng ‚Üí R·ªùi party
                    if not isLeader() then
                        local myPartyId = getMyPartyId()
                        if myPartyId then
                            -- Ki·ªÉm tra leader c√≥ trong party n√†y kh√¥ng
                            local leaderName = PartyGlobals.PartySetup.Leader
                            if not isInParty(leaderName) then
                                warn("‚ö†Ô∏è ƒêang ·ªü party kh√°c, kh√¥ng c√≥ leader ‚Üí R·ªùi party")
                                pcall(function()
                                    local success = game:GetService("ReplicatedStorage"):WaitForChild("Shared"):WaitForChild("Party"):WaitForChild("LeaveParty"):InvokeServer()
                                    if success then
                                        warn("‚úÖ ƒê√£ r·ªùi party sai th√†nh c√¥ng")
                                    else
                                        warn("‚ö†Ô∏è LeaveParty tr·∫£ v·ªÅ false")
                                    end
                                    task.wait(2)
                                end)
                            end
                        end
                        
                        -- ‚úÖ TH√äM: Member ki·ªÉm tra c√≥ ƒëang ·ªü ƒë√∫ng JobId kh√¥ng
                        warn("üìÇ [MEMBER] Ki·ªÉm tra c√≥ ƒëang ·ªü ƒë√∫ng JobId kh√¥ng...")
                        local expectedJobId = getMarketplaceJobId()
                        
                        if expectedJobId and game.JobId ~= expectedJobId then
                            warn("‚ö†Ô∏è [MEMBER] ƒêang ·ªü sai JobId!")
                            warn("‚ö†Ô∏è [MEMBER] Current JobId:", game.JobId:sub(1,20))
                            warn("‚ö†Ô∏è [MEMBER] Expected JobId:", expectedJobId:sub(1,20))
                            
                            WindUI:Notify({
                                Title = "Wrong Server",
                                Content = "üîÑ Sai server! ƒêang rejoin Marketplace...",
                                Duration = 5
                            })
                            
                            task.wait(2)
                            SharedJobIdSystem:TeleportToPlace(7499964980, expectedJobId)
                            return
                        end
                    end
                    
                    -- Leader m·ªùi members
                    if isLeader() then
                        for _, memberName in ipairs(missingMembers) do
                            if game:GetService("Players"):FindFirstChild(memberName) then
                                inviteMember(memberName)
                                task.wait(2)
                            end
                        end
                    end
                    
                    -- Member accept invite t·ª´ leader
                    if not isLeader() then
                        local leaderName = PartyGlobals.PartySetup.Leader
                        if game:GetService("Players"):FindFirstChild(leaderName) then
                            acceptInvite(leaderName)
                        end
                    end
                    
                    rejoinAttempts = 0
                end
                
                -- ‚úÖ N·∫æU C√ì NG∆Ø·ªúI ONLINE NH∆ØNG KH√ÅC SERVER HO·∫∂C KH√îNG PH·∫¢I MARKETPLACE
                if onlineMissingCount > 0 and not isInMarketplace() then
                    local timeSinceLastRejoin = tick() - lastRejoinTime
                    
                    if timeSinceLastRejoin >= 60 and rejoinAttempts < 5 then
                        warn("üîÑ Ng∆∞·ªùi online nh∆∞ng kh√°c server ho·∫∑c kh√¥ng ·ªü Marketplace ‚Üí Rejoin")
                        rejoinAttempts = rejoinAttempts + 1
                        lastRejoinTime = tick()
                        
                        local targetJobId = getMarketplaceJobId()
                        local targetPlaceId = PartyGlobals.SharedRejoinPlaceId or 7499964980
                        
                        if targetJobId then
                            if game.JobId == targetJobId and game.PlaceId == targetPlaceId then
                                warn("‚úÖ ƒê√£ ·ªü ƒë√∫ng server Marketplace, kh√¥ng c·∫ßn rejoin")
                            else
                                warn("üõí Rejoin v·ªÅ Marketplace - JobId:", targetJobId:sub(1,20))
                                
                                WindUI:Notify({
                                    Title = "Party Sync",
                                    Content = "üîÑ ƒêang rejoin v·ªÅ Marketplace...",
                                    Duration = 5
                                })
                                
                                task.wait(2)
                                SharedJobIdSystem:TeleportToPlace(targetPlaceId, targetJobId)
                                return
                            end
                        else
                            warn("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c JobId t·ª´ API")
                        end
                    end
                end
            end
            
            -- ‚úÖ S·ª¨ D·ª§NG DELAY T·ª™ SLIDER
            task.wait(PartyGlobals.PartyCheckDelay)
        end
        PartyGlobals.isMonitoringParty = false
    end)
end
-- ==================== CONFIG FUNCTIONS ====================
local function savePartyConfig()
    if not writefile or PartyGlobals.isLoadingPartyConfig then return end
    
    local data = {
        Leader = PartyGlobals.PartySetup.Leader,
        Members = PartyGlobals.PartySetup.Members
    }
    writefile(PartyGlobals.PartyConfigFile, e:JSONEncode(data))
    warn("üíæ Saved party config")
end

local function loadPartyConfig()
    if not isfile or not isfile(PartyGlobals.PartyConfigFile) then 
        return false 
    end
    
    PartyGlobals.isLoadingPartyConfig = true
    
    local success = pcall(function()
        local content = readfile(PartyGlobals.PartyConfigFile)
        local data = e:JSONDecode(content)
        
        if data then
            PartyGlobals.PartySetup.Leader = data.Leader or ""
            for i = 1, 5 do
                PartyGlobals.PartySetup.Members[i] = (data.Members and data.Members[i]) or ""
            end
            
            warn("üìÇ Loaded party config")
            
            task.delay(0.1, function()
                PartyGlobals.isLoadingPartyConfig = false
            end)
            
            return true
        end
    end)
    
    if not success then
        PartyGlobals.isLoadingPartyConfig = false
    end
    
    return success
end

-- ==================== UI CREATION ====================
local function createRejoinSystemUI(TabParty)
    TabParty:Divider({ Text = "üîÑ Auto Rejoin System" })
    
    local jobIdPara = TabParty:Paragraph({ 
        Title = "üìç Shared Rejoin JobId", 
        Description = "Loading..." 
    })
    
    local rejoinStatusPara = TabParty:Paragraph({ 
        Title = "üîÑ Rejoin Status", 
        Description = "Disabled" 
    })
    
    task.spawn(function()
        while task.wait(5) do
            pcall(function()
                local desc = "ƒêang l·∫•y JobId..."
                
                -- L·∫•y JobId m·ªõi nh·∫•t t·ª´ API (c√≥ fallback World 1)
                local jobId = SharedJobIdSystem:GetMarketplaceJobIdFromAPI()
                
                if jobId and jobId ~= "" then
                    desc = "üõí Marketplace JobId:\n  " .. jobId:sub(1, 25) .. "..."
                    desc = desc .. "\n  Source: API"
                    desc = desc .. "\n  PlaceId: 7499964980"
                else
                    -- Fallback: Hi·ªÉn th·ªã World 1
                    local world1Server = SharedJobIdSystem:GetWorld1JobId()
                    if world1Server and world1Server.JobId then
                        desc = "üåç World 1 JobId (Fallback):\n  " .. world1Server.JobId:sub(1, 25) .. "..."
                        desc = desc .. "\n  Source: Cache"
                        desc = desc .. "\n  PlaceId: 4310463616"
                    else
                        desc = "‚ö†Ô∏è API fail + Ch∆∞a scan World 1\n  H√£y ƒë·ª£i auto scan..."
                    end
                end
                
                jobIdPara:SetDesc(desc)
            end)
        end
    end)
    
    ConfigSystem.registerUIElement("AutoRejoin", TabParty:Toggle({ 
        Title = "Auto Rejoin on Disconnect", 
        Description = "T·ª± ƒë·ªông rejoin + reform party", 
        Default = ToggleStates.AutoRejoin or false,
        Callback = function(s) 
            if Toggles.AutoRejoin then
                Toggles.AutoRejoin:SetValue(s)
            end
            
            if s then
                rejoinStatusPara:SetDesc("‚úÖ Enabled")
            else
                rejoinStatusPara:SetDesc("‚ùå Disabled")
            end
        end 
    }))
    
    TabParty:Button({
        Title = "üîÑ Test API JobId",
        Description = "L·∫•y JobId m·ªõi t·ª´ API ƒë·ªÉ test",
        Callback = function()
            local jobId = SharedJobIdSystem:GetMarketplaceJobIdFromAPI()
            if jobId then
                WindUI:Notify({
                    Title = "API JobId",
                    Content = "‚úÖ JobId: " .. jobId:sub(1, 20) .. "...",
                    Duration = 5
                })
            else
                WindUI:Notify({
                    Title = "API Error",
                    Content = "‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c JobId t·ª´ API",
                    Duration = 3
                })
            end
        end
    })
end

local function createAutoPartyTab()
    local TabParty = Window:Tab({
        Title = "Auto Party",
        Icon = "users",
        Locked = false,
    })
    
    _G.loadPartyConfigGlobal = loadPartyConfig
    _G.PartySetup = PartyGlobals.PartySetup
    
    local rolePara = TabParty:Paragraph({ 
        Title = "üé≠ My Role", 
        Description = "Not configured" 
    })
    
    local statusPara = TabParty:Paragraph({ 
        Title = "Current Party", 
        Description = "Not configured" 
    })
    
    local function updateStatus()
        local roleText = ""
        if PartyGlobals.PartySetup.Leader == c.Name then
            roleText = "üëë LEADER"
        elseif PartyGlobals.PartySetup.Leader ~= "" then
            roleText = "üë§ MEMBER\nLeader: " .. PartyGlobals.PartySetup.Leader
        else
            roleText = "‚ö†Ô∏è Not configured"
        end
        rolePara:SetDesc(roleText)
        
        local s = ""
        if PartyGlobals.PartySetup.Leader ~= "" then 
            local leaderInGame = game:GetService("Players"):FindFirstChild(PartyGlobals.PartySetup.Leader)
            local isYou = PartyGlobals.PartySetup.Leader == c.Name and " (You)" or ""
            s = s .. (leaderInGame and "‚úÖ" or "‚ùå") .. " Leader: " .. PartyGlobals.PartySetup.Leader .. isYou .. "\n" 
        end
        
        for i, m in ipairs(PartyGlobals.PartySetup.Members) do 
            if m ~= "" then 
                local memberInGame = game:GetService("Players"):FindFirstChild(m)
                local inPartyStatus = isInParty(m) and "üü¢" or "‚ö™"
                local isYou = m == c.Name and " (You)" or ""
                s = s .. (memberInGame and "‚úÖ" or "‚ùå") .. inPartyStatus .. " M" .. i .. ": " .. m .. isYou .. "\n" 
            end 
        end
        
        local currentCount = getCurrentPartyMemberCount()
        local expectedCount = getExpectedPartySize()
        s = s .. "\nüìä Party: " .. currentCount .. "/" .. expectedCount .. " members"
        
        statusPara:SetDesc(s ~= "" and s or "Not configured")
    end
    
    _G.updatePartyStatus = updateStatus
    
    TabParty:Divider({ Text = "Party Setup" })
    
    local function getPlayersListWithNone()
        local list = {"-- None --"}
        for _, name in ipairs(getPlayersList()) do
            table.insert(list, name)
        end
        return list
    end
    
    TabParty:Dropdown({ 
        Title = "Party Leader", 
        Description = "Ch·ªçn t√™n player l√†m leader (None ƒë·ªÉ x√≥a)", 
        Values = getPlayersListWithNone(), 
        Multi = false, 
        Callback = function(v) 
            if PartyGlobals.isInitializingUI then return end
            
            if v == "-- None --" or not v then
                PartyGlobals.PartySetup.Leader = ""
            else
                PartyGlobals.PartySetup.Leader = v
            end
            updateStatus()
            savePartyConfig()
        end 
    })
    
    for i = 1, 5 do 
        TabParty:Dropdown({ 
            Title = "Member " .. i, 
            Description = "Ch·ªçn t√™n player (None ƒë·ªÉ x√≥a)", 
            Values = getPlayersListWithNone(), 
            Multi = false, 
            Callback = function(v) 
                if PartyGlobals.isInitializingUI then return end
                
                if v == "-- None --" or not v then
                    PartyGlobals.PartySetup.Members[i] = ""
                else
                    PartyGlobals.PartySetup.Members[i] = v
                end
                updateStatus()
                savePartyConfig()
            end 
        })
    end
    
    task.spawn(function()
        task.wait(1)
        local loaded = loadPartyConfig()
        task.wait(0.5)
        PartyGlobals.isInitializingUI = false
        
        if loaded then
            updateStatus()
            WindUI:Notify({
                Title = "Party Config",
                Content = "‚úÖ Loaded - " .. (isLeader() and "üëë Leader" or "üë§ Member"),
                Duration = 3
            })
        end
    end)
    
    TabParty:Divider({ Text = "Actions" })
    
    TabParty:Button({ 
        Title = "Refresh Status", 
        Description = "C·∫≠p nh·∫≠t status", 
        Callback = function() 
            updateStatus()
            WindUI:Notify({ Title = "Success", Content = "Refreshed!", Duration = 2 }) 
        end 
    })
    
    TabParty:Button({ 
        Title = "Save Party Config", 
        Description = "L∆∞u party setup", 
        Callback = function() 
            savePartyConfig()
            WindUI:Notify({ Title = "Success", Content = "‚úÖ ƒê√£ l∆∞u!", Duration = 3 })
        end 
    })
    
    TabParty:Divider({ Text = "Automation" })
    
    ConfigSystem.registerUIElement("AutoInviteAll", TabParty:Toggle({ 
        Title = "Auto Invite All", 
        Description = "T·ª± ƒë·ªông m·ªùi members (Leader only)",
        Default = ToggleStates.AutoInviteAll or false,
        Callback = function(s) 
            if Toggles.AutoInviteAll then
                Toggles.AutoInviteAll:SetValue(s)
            end
            
            if s then
                if not isLeader() then
                    WindUI:Notify({
                        Title = "Warning",
                        Content = "‚ö†Ô∏è B·∫°n kh√¥ng ph·∫£i leader!",
                        Duration = 3
                    })
                end
                
                task.spawn(function() 
                    while Toggles.AutoInviteAll and Toggles.AutoInviteAll.Value do
                        if isLeader() then
                            local membersToInvite = getMembersToInvite()
                            
                            for _, n in ipairs(membersToInvite) do 
                                if not isInParty(n) then
                                    inviteMember(n)
                                    task.wait(3)
                                end
                            end
                        end
                        
                        task.wait(25)
                    end 
                end) 
            end 
        end 
    }))
    
    createRejoinSystemUI(TabParty)
    
    TabParty:Divider({ Text = "Party Control" })
    
    ConfigSystem.registerUIElement("AutoAcceptInvite", TabParty:Toggle({ 
        Title = "Auto Accept Invite", 
        Description = "T·ª± ƒë·ªông accept invite t·ª´ leader (Member only)", 
        Default = ToggleStates.AutoAcceptInvite or false,
        Callback = function(s) 
            if Toggles.AutoAcceptInvite then
                Toggles.AutoAcceptInvite:SetValue(s)
            end
            
            if s then
                if isLeader() then
                    WindUI:Notify({
                        Title = "Warning",
                        Content = "‚ö†Ô∏è B·∫°n l√† leader!",
                        Duration = 3
                    })
                end
                
                task.spawn(function()
                    while Toggles.AutoAcceptInvite and Toggles.AutoAcceptInvite.Value do
                        if not isLeader() then
                            pcall(function()
                                local leaderPlayer = game:GetService("Players"):FindFirstChild(PartyGlobals.PartySetup.Leader)
                                
                                if leaderPlayer then
                                    local currentPartyId = getMyPartyId()
                                    
                                    if not currentPartyId then
                                        warn("üì® ƒêang th·ª≠ accept invite t·ª´:", PartyGlobals.PartySetup.Leader)
                                        acceptInvite(PartyGlobals.PartySetup.Leader)
                                        
                                        task.wait(2)
                                        
                                        local newPartyId = getMyPartyId()
                                        if newPartyId then
                                            WindUI:Notify({
                                                Title = "Party",
                                                Content = "‚úÖ ƒê√£ v√†o party v·ªõi " .. PartyGlobals.PartySetup.Leader,
                                                Duration = 3
                                            })
                                            warn("‚úÖ ƒê√£ v√†o party th√†nh c√¥ng!")
                                        end
                                    end
                                end
                            end)
                        end
                        
                        task.wait(3)
                    end
                    
                    warn("‚ùå Auto Accept Invite ƒë√£ t·∫Øt")
                end)
            end
        end 
    }))
    
    ConfigSystem.registerUIElement("AutoPartyMonitor", TabParty:Toggle({ 
        Title = "Auto Monitor Party", 
        Description = "T·ª± ƒë·ªông rejoin Marketplace (API) ho·∫∑c World 1 (fallback) + auto reform party", 
        Default = ToggleStates.AutoPartyMonitor or false,
        Callback = function(s) 
            if Toggles.AutoPartyMonitor then
                Toggles.AutoPartyMonitor:SetValue(s)
            end
            
            if s then 
                startPartyMonitoring() 
            end 
        end 
    }))
    
    task.spawn(function() 
        while task.wait(3) do 
            updateStatus() 
        end 
    end)
end

-- ==================== INIT MODULE ====================
function Module:Init()
    SharedJobIdSystem:StartMonitoring()
    createAutoPartyTab()
    warn("‚úÖ Auto Party Module loaded!")
end

return Module
