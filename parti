-- ==================== AUTO PARTY MODULE (API VERSION) ====================
-- Thay ƒë·ªïi t·ª´ code c≈©:
-- - PlaceId: 4310463616 (World 1) ‚Üí 7499964980 (Marketplace)
-- - JobId: t·ª´ scan World 1 ‚Üí t·ª´ API
-- ===========================================================================

local Module = {}

-- ‚úÖ L·∫•y c√°c bi·∫øn c·∫ßn thi·∫øt t·ª´ file ch√≠nh
local WindUI = _G.WindUI
local Window = _G.Window
local c = _G.PlayerLocal
local d = _G.UserId
local e = _G.HttpService
local a6 = _G.TeleportService
local aC = _G.CurrentDungeon
local ay = _G.CurrentDungeonId
local az = _G.CurrentDifficulty
local ce = _G.DungeonsList
local cc = _G.WorldsList
local ToggleStates = _G.ToggleStates
local Toggles = _G.Toggles
local ConfigSystem = _G.ConfigSystem
local a5 = game:GetService("ReplicatedStorage"):WaitForChild('Shared')

-- ‚úÖ PERSISTENT DATA
local ao = {
    PartyRejoinDungeon = false,
    PartyDungeonJobId = nil,
    PartyDungeonPlaceId = nil,
    PartyDungeonId = nil,
    PartyDifficulty = nil,
    PartyTimestamp = 0,
    PartyThreshold = 600
}
local partyDataFile = 'AnyaHub_PartyDungeonData.txt'

local function savePartyData()
    if not writefile then return end
    pcall(function()
        writefile(partyDataFile, e:JSONEncode(ao))
    end)
end

local function loadPartyData()
    if not (readfile and isfile and isfile(partyDataFile)) then return false end
    local success = pcall(function()
        ao = e:JSONDecode(readfile(partyDataFile))
    end)
    return success
end

local PartyGlobals = {
    PartySetup = { Leader = "", Members = {"", "", "", "", ""} },
    isMonitoringParty = false,
    isLoadingPartyConfig = false,
    isInitializingUI = true,
    globalInviteCooldown = {},
    GLOBAL_INVITE_COOLDOWN = 30,
    PartyConfigFile = "AnyaHub_PartyConfig_" .. c.Name .. ".txt",
    SharedRejoinJobId = nil,
    SharedRejoinPlaceId = nil,
    SharedRejoinFile = 'AnyaHub_PartySharedRejoin.txt',
    DungeonRejoinFile = 'AnyaHub_DungeonRejoin.txt',
    PartyCheckDelay = 10,
    LastDungeonJobId = nil,
    LastDungeonPlaceId = nil
}

local SharedJobIdSystem = {
    CurrentJobId = nil,
    LastUpdateTime = 0,
    UpdateInterval = 5,
    FilePath = d .. '_SharedJobId.txt',
    InDungeon = false,
    LastDungeonInfo = nil,
    ValidWorlds = {
        {PlaceId = 4310463616, Name = 'World 1'},
        {PlaceId = 4310463940, Name = 'World 2'},
        {PlaceId = 4465987684, Name = 'World 3'},
        {PlaceId = 4646472003, Name = 'World 4'},
        {PlaceId = 5703355191, Name = 'World 5'},
        {PlaceId = 6075083204, Name = 'World 6'},
        {PlaceId = 6847035264, Name = 'World 7'},
        {PlaceId = 9944262922, Name = 'World 8'},
        {PlaceId = 10651517727, Name = 'World 9'},
        {PlaceId = 14914684761, Name = 'World 10'},
        {PlaceId = 6510868181, Name = 'PvpArena'},
        {PlaceId = 7499964980, Name = 'Marketplace'}
    }
}

-- ==================== MARKETPLACE API SYSTEM ====================
function SharedJobIdSystem:GetRequestFunction()
    return (syn and syn.request) or 
           (http and http.request) or 
           (http_request) or 
           (fluxus and fluxus.request) or
           request
end

-- ‚úÖ L·∫§Y JOBID T·ª™ API (THAY CHO SCAN WORLD 1)
function SharedJobIdSystem:GetMarketplaceJobIdFromAPI()
    local requestFunc = self:GetRequestFunction()
    
    if not requestFunc then
        warn("‚ùå Executor kh√¥ng h·ªó tr·ª£ HTTP request")
        return nil
    end
    
    local success, result = pcall(function()
        local response = requestFunc({
            Url = "https://web-production-d07d6.up.railway.app/api/jobid",
            Method = "GET"
        })
        
        if response and response.StatusCode == 200 and response.Body then
            local jobId = response.Body:match("^%s*(.-)%s*$")
            if jobId and jobId ~= "" and #jobId > 10 then
                warn("‚úÖ [API] JobId:", jobId:sub(1, 20))
                return jobId
            end
        end
        return nil
    end)
    
    return success and result or nil
end

function SharedJobIdSystem:TeleportToPlace(targetPlaceId, targetJobId)
    if not targetJobId or targetJobId == "" then return false end
    pcall(function()
        a6:TeleportToPlaceInstance(targetPlaceId, targetJobId, c)
    end)
    return true
end

function SharedJobIdSystem:StartMonitoring()
    task.spawn(function()
        while task.wait(self.UpdateInterval) do
            pcall(function()
                if aC then
                    self.InDungeon = true
                end
            end)
        end
    end)
end

-- ==================== PARTY FUNCTIONS ====================
local function timeElapsed(seconds)
    local mins = math.floor(seconds / 60)
    local secs = seconds % 60
    return string.format("%dm %ds", mins, secs)
end

local function getPlayersList()
    local players = {}
    for _, player in ipairs(game:GetService("Players"):GetPlayers()) do
        table.insert(players, player.Name)
    end
    table.sort(players)
    return players
end

local function isLeader()
    return PartyGlobals.PartySetup.Leader == c.Name
end

-- ‚úÖ KI·ªÇM TRA ·ªû MARKETPLACE (THAY CHO WORLD 1)
local function isInMarketplace()
    return game.PlaceId == 7499964980
end

local function isInDungeon()
    return aC ~= nil
end

local function isInValidWorld()
    local currentPlaceId = game.PlaceId
    for _, world in ipairs(SharedJobIdSystem.ValidWorlds) do
        if world.PlaceId == currentPlaceId then
            return true
        end
    end
    return false
end

local function getMyPartyId()
    local success, partyId = pcall(function()
        local Parties = game:GetService("ReplicatedStorage"):FindFirstChild("Parties")
        if not Parties then return nil end
        
        for _, party in ipairs(Parties:GetChildren()) do
            local Members = party:FindFirstChild("Members")
            if Members then
                for _, memberFolder in ipairs(Members:GetChildren()) do
                    if memberFolder.Name == c.Name then
                        return party.Name
                    end
                end
            end
        end
        return nil
    end)
    return success and partyId or nil
end

local function isInParty(playerName)
    local partyId = getMyPartyId()
    if not partyId then return false end
    
    local success, result = pcall(function()
        local Parties = game:GetService("ReplicatedStorage"):FindFirstChild("Parties")
        if not Parties then return false end
        
        local myParty = Parties:FindFirstChild(partyId)
        if not myParty then return false end
        
        local Members = myParty:FindFirstChild("Members")
        if not Members then return false end
        
        return Members:FindFirstChild(playerName) ~= nil
    end)
    return success and result or false
end

local function getCurrentPartyMemberCount()
    local partyId = getMyPartyId()
    if not partyId then return 0 end
    
    local success, count = pcall(function()
        local Parties = game:GetService("ReplicatedStorage"):FindFirstChild("Parties")
        if not Parties then return 0 end
        
        local myParty = Parties:FindFirstChild(partyId)
        if not myParty then return 0 end
        
        local Members = myParty:FindFirstChild("Members")
        if not Members then return 0 end
        
        return #Members:GetChildren()
    end)
    return success and count or 0
end

local function getExpectedPartySize()
    local count = 1
    for _, memberName in ipairs(PartyGlobals.PartySetup.Members) do
        if memberName ~= "" then
            count = count + 1
        end
    end
    return count
end

local function getOnlineMembersCount()
    local count = 0
    if PartyGlobals.PartySetup.Leader ~= "" then
        if game:GetService("Players"):FindFirstChild(PartyGlobals.PartySetup.Leader) then
            count = count + 1
        end
    end
    for _, memberName in ipairs(PartyGlobals.PartySetup.Members) do
        if memberName ~= "" then
            if game:GetService("Players"):FindFirstChild(memberName) then
                count = count + 1
            end
        end
    end
    return count
end

local function areAllMembersOnline()
    if PartyGlobals.PartySetup.Leader ~= "" then
        if not game:GetService("Players"):FindFirstChild(PartyGlobals.PartySetup.Leader) then
            return false
        end
    end
    for _, memberName in ipairs(PartyGlobals.PartySetup.Members) do
        if memberName ~= "" then
            if not game:GetService("Players"):FindFirstChild(memberName) then
                return false
            end
        end
    end
    return true
end

local function inviteMember(playerName)
    local currentTime = tick()
    local lastInvited = PartyGlobals.globalInviteCooldown[playerName] or 0
    local timeSinceInvite = currentTime - lastInvited
    
    if timeSinceInvite < PartyGlobals.GLOBAL_INVITE_COOLDOWN then
        warn("‚è≥ Invite cooldown active for", playerName)
        return
    end
    
    pcall(function()
        local player = game:GetService("Players"):FindFirstChild(playerName)
        if player then
            game:GetService("ReplicatedStorage").Shared.Party.Invite:FireServer(player)
            PartyGlobals.globalInviteCooldown[playerName] = currentTime
            warn("üì§ Sent Invite to:", playerName)
            WindUI:Notify({
                Title = "Party Invite",
                Content = "üì§ Invited " .. playerName,
                Duration = 2
            })
        end
    end)
end

local function acceptInvite(fromPlayer)
    pcall(function()
        local args = {[1] = game:GetService("Players"):WaitForChild(fromPlayer)}
        game:GetService("ReplicatedStorage"):WaitForChild("Shared"):WaitForChild("Party"):WaitForChild("AcceptedInvite"):FireServer(unpack(args))
        warn("‚úÖ Accepted invite from:", fromPlayer)
        WindUI:Notify({
            Title = "Party Invite",
            Content = "‚úÖ Accepted from " .. fromPlayer,
            Duration = 2
        })
    end)
end

local function getMembersToInvite()
    local toInvite = {}
    for _, memberName in ipairs(PartyGlobals.PartySetup.Members) do
        if memberName ~= "" and memberName ~= c.Name then
            table.insert(toInvite, memberName)
        end
    end
    return toInvite
end

local function getMissingMembers()
    local missing = {}
    for _, memberName in ipairs(getMembersToInvite()) do
        if not isInParty(memberName) then
            table.insert(missing, memberName)
        end
    end
    return missing
end

-- ‚úÖ L∆ØU/T·∫¢I JOBID MARKETPLACE (THAY CHO WORLD 1)
local function saveSharedRejoinJobId(placeId, jobId)
    if not writefile then return false end
    
    local success = pcall(function()
        local data = {
            PlaceId = placeId,
            JobId = jobId,
            Timestamp = tick()
        }
        writefile(PartyGlobals.SharedRejoinFile, e:JSONEncode(data))
        PartyGlobals.SharedRejoinPlaceId = placeId
        PartyGlobals.SharedRejoinJobId = jobId
        warn("üíæ [SAVE] PlaceId:", placeId, "JobId:", jobId:sub(1,20))
    end)
    return success
end

local function loadSharedRejoinJobId()
    if not (readfile and isfile and isfile(PartyGlobals.SharedRejoinFile)) then
        return nil
    end
    
    local success, result = pcall(function()
        local content = readfile(PartyGlobals.SharedRejoinFile)
        local data = e:JSONDecode(content)
        
        local timeDiff = tick() - (data.Timestamp or 0)
        if timeDiff > 1800 then return nil end
        
        PartyGlobals.SharedRejoinPlaceId = data.PlaceId
        PartyGlobals.SharedRejoinJobId = data.JobId
        warn("‚úÖ [LOAD] PlaceId:", data.PlaceId, "JobId:", data.JobId:sub(1,20))
        return data
    end)
    return success and result or nil
end

local function reloadSharedRejoinJobId()
    warn("üîÑ [RELOAD] ƒêang ƒë·ªìng b·ªô JobId t·ª´ file...")
    local loaded = loadSharedRejoinJobId()
    if loaded then
        warn("‚úÖ [RELOAD] ƒê√£ ƒë·ªìng b·ªô JobId:", loaded.JobId:sub(1,20))
        return true
    else
        warn("‚ùå [RELOAD] Kh√¥ng c√≥ JobId ƒë·ªÉ ƒë·ªìng b·ªô")
        return false
    end
end

local function saveDungeonJobId()
    if not (writefile and aC) then return end
    pcall(function()
        local data = {
            PlaceId = game.PlaceId,
            JobId = game.JobId,
            Timestamp = tick(),
            DungeonId = ay,
            Difficulty = az
        }
        writefile(PartyGlobals.DungeonRejoinFile, e:JSONEncode(data))
        PartyGlobals.LastDungeonJobId = game.JobId
        PartyGlobals.LastDungeonPlaceId = game.PlaceId
        warn("üíæ [DUNGEON] JobId:", game.JobId:sub(1,20))
    end)
end

local function loadDungeonJobId()
    if not (readfile and isfile and isfile(PartyGlobals.DungeonRejoinFile)) then
        return nil
    end
    
    local success, result = pcall(function()
        local content = readfile(PartyGlobals.DungeonRejoinFile)
        local data = e:JSONDecode(content)
        
        local timeDiff = tick() - (data.Timestamp or 0)
        if timeDiff > 600 then return nil end
        
        PartyGlobals.LastDungeonJobId = data.JobId
        PartyGlobals.LastDungeonPlaceId = data.PlaceId
        warn("‚úÖ [DUNGEON] ƒê√£ t·∫£i JobId:", data.JobId:sub(1,20))
        return data
    end)
    return success and result or nil
end

-- ==================== PARTY MONITORING (GI·ªêNG CODE C≈®, CH·ªà ƒê·ªîI PLACEID V√Ä JOBID SOURCE) ====================
local function startPartyMonitoring()
    if PartyGlobals.isMonitoringParty then
        warn("‚ö†Ô∏è Party monitoring already active")
        return
    end
    
    PartyGlobals.isMonitoringParty = true
    warn("‚úÖ Started party monitoring")
    
    loadPartyData()
    
    if aC then
        warn("üîç ƒêang trong dungeon - L∆∞u th√¥ng tin...")
        ao.PartyRejoinDungeon = true
        ao.PartyDungeonJobId = game.JobId
        ao.PartyDungeonPlaceId = game.PlaceId
        ao.PartyDungeonId = ay
        ao.PartyDifficulty = az
        ao.PartyTimestamp = tick()
        savePartyData()
        warn("üíæ ƒê√£ l∆∞u: DungeonId=", ay, "Difficulty=", az)
    end
    
    local rejoinAttempts = 0
    local lastRejoinTime = 0
    
    task.spawn(function()
        while Toggles.AutoPartyMonitor and Toggles.AutoPartyMonitor.Value do
            -- ‚úÖ B∆Ø·ªöC 1: TELEPORT V·ªÄ MARKETPLACE N·∫æU ·ªû WORLD KH√ÅC (THAY V√å WORLD 1)
            if isInValidWorld() and not isInMarketplace() then
                warn("‚ö†Ô∏è ƒêang ·ªü World kh√°c (PlaceId:", game.PlaceId, ") ‚Üí Chu·∫©n b·ªã teleport v·ªÅ Marketplace")
                
                local targetPlaceId = 7499964980 -- ‚úÖ MARKETPLACE THAY V√å WORLD 1
                local targetJobId
                
                reloadSharedRejoinJobId()
                task.wait(0.5)
                
                if PartyGlobals.SharedRejoinJobId then
                    targetJobId = PartyGlobals.SharedRejoinJobId
                    warn("‚úÖ S·ª≠ d·ª•ng Shared JobId:", targetJobId:sub(1,20))
                else
                    if isLeader() then
                        warn("üëë LEADER l·∫•y JobId t·ª´ API...")
                        targetJobId = SharedJobIdSystem:GetMarketplaceJobIdFromAPI() -- ‚úÖ API THAY V√å SCAN
                        if targetJobId then
                            saveSharedRejoinJobId(targetPlaceId, targetJobId)
                            warn("‚úÖ LEADER ƒë√£ l∆∞u JobId t·ª´ API:", targetJobId:sub(1,20))
                            task.wait(3)
                        else
                            warn("‚ùå API kh√¥ng tr·∫£ v·ªÅ JobId")
                        end
                    else
                        warn("üë§ MEMBER ƒë·ª£i LEADER t·∫°o JobId...")
                        for retry = 1, 60 do
                            task.wait(5)
                            if reloadSharedRejoinJobId() then
                                targetPlaceId = PartyGlobals.SharedRejoinPlaceId or 7499964980
                                targetJobId = PartyGlobals.SharedRejoinJobId
                                warn("‚úÖ MEMBER nh·∫≠n JobId t·ª´ LEADER:", targetJobId:sub(1,20))
                                break
                            else
                                warn("‚ö†Ô∏è MEMBER ch∆∞a nh·∫≠n ƒë∆∞·ª£c JobId (L·∫ßn", retry, "/60)")
                            end
                        end
                    end
                end
                
                if targetJobId then
                    if game.JobId == targetJobId and game.PlaceId == targetPlaceId then
                        warn("‚úÖ ƒê√£ ·ªü ƒë√∫ng JobId Marketplace")
                    else
                        warn("üõí Teleport v·ªÅ Marketplace JobId:", targetJobId:sub(1,20))
                        WindUI:Notify({
                            Title = "Auto Party",
                            Content = "üõí ƒêang v·ªÅ Marketplace...",
                            Duration = 5
                        })
                        task.wait(2)
                        SharedJobIdSystem:TeleportToPlace(targetPlaceId, targetJobId)
                        return
                    end
                end
            end
            
            local expectedTotal = getExpectedPartySize()
            local currentCount = getCurrentPartyMemberCount()
            local onlineCount = getOnlineMembersCount()
            local allOnline = areAllMembersOnline()
            
            warn("üìä Party: ", currentCount, "/", expectedTotal, "(Online:", onlineCount, "/", expectedTotal, ")")
            
            -- ‚úÖ RESTART DUNGEON N·∫æU ƒê·ª¶ NG∆Ø·ªúI V√Ä ·ªû MARKETPLACE
            if currentCount >= expectedTotal and allOnline and isInMarketplace() then
                warn("‚úÖ Party ƒë·ªß ng∆∞·ªùi + Online + ·ªû Marketplace")
                
                loadPartyData()
                task.wait(0.5)
                
                if ao.PartyRejoinDungeon and ao.PartyDungeonId and ao.PartyDifficulty then
                    local timeDiff = tick() - ao.PartyTimestamp
                    
                    if timeDiff <= ao.PartyThreshold then
                        warn("üéØ C√≥ dungeon ‚Üí Restart!")
                        
                        WindUI:Notify({
                            Title = "Party Ready",
                            Content = "üéØ ƒê·ªß ng∆∞·ªùi! Restart sau 5s...",
                            Duration = 5
                        })
                        
                        task.wait(5)
                        
                        if isLeader() then
                            warn("üëë LEADER restart dungeon")
                            pcall(function()
                                local StartRaid = a5:WaitForChild('Teleport'):WaitForChild('StartRaid')
                                StartRaid:FireServer(ao.PartyDungeonId, ao.PartyDifficulty)
                                WindUI:Notify({
                                    Title = "Party Leader",
                                    Content = "üëë Restarting...",
                                    Duration = 5
                                })
                            end)
                            
                            task.wait(3)
                            ao.PartyRejoinDungeon = false
                            ao.PartyDungeonJobId = nil
                            ao.PartyDungeonPlaceId = nil
                            ao.PartyDungeonId = nil
                            ao.PartyDifficulty = nil
                            savePartyData()
                        else
                            warn("üë§ MEMBER ƒë·ª£i LEADER restart...")
                            WindUI:Notify({
                                Title = "Party Member",
                                Content = "‚è≥ ƒê·ª£i LEADER...",
                                Duration = 5
                            })
                        end
                        
                        task.wait(PartyGlobals.PartyCheckDelay)
                        continue
                    end
                end
            end
            
            -- ‚úÖ N·∫æU PARTY ƒê·∫¶Y NH∆ØNG C√ì NG∆Ø·ªúI OFFLINE ‚Üí REJOIN
            if currentCount >= expectedTotal and not allOnline then
                warn("üî¥ Party ƒë·ªß nh∆∞ng c√≥ ng∆∞·ªùi offline ‚Üí Rejoin")
                
                pcall(function()
                    game:GetService("ReplicatedStorage"):WaitForChild("Shared"):WaitForChild("Party"):WaitForChild("LeaveParty"):InvokeServer()
                    warn("‚úÖ ƒê√£ tho√°t party")
                end)
                
                task.wait(2)
                
                local targetPlaceId = 7499964980
                local targetJobId
                
                reloadSharedRejoinJobId()
                task.wait(0.5)
                
                if PartyGlobals.SharedRejoinJobId then
                    targetJobId = PartyGlobals.SharedRejoinJobId
                else
                    if isLeader() then
                        targetJobId = SharedJobIdSystem:GetMarketplaceJobIdFromAPI()
                        if targetJobId then
                            saveSharedRejoinJobId(targetPlaceId, targetJobId)
                            task.wait(3)
                        end
                    else
                        for retry = 1, 10 do
                            task.wait(5)
                            if reloadSharedRejoinJobId() then
                                targetJobId = PartyGlobals.SharedRejoinJobId
                                break
                            end
                        end
                    end
                end
                
                if targetJobId then
                    if game.JobId ~= targetJobId or game.PlaceId ~= targetPlaceId then
                        SharedJobIdSystem:TeleportToPlace(targetPlaceId, targetJobId)
                        return
                    end
                end
            end
            
            -- ‚úÖ PARTY ƒê·ª¶ NG∆Ø·ªúI
            if currentCount >= expectedTotal and allOnline then
                warn("‚úÖ Party ƒë·ªß!")
                rejoinAttempts = 0
                
                if isInMarketplace() and allOnline then
                    local dungeonData = loadDungeonJobId()
                    if dungeonData and dungeonData.JobId then
                        warn("üéØ Quay l·∫°i dungeon")
                        WindUI:Notify({
                            Title = "Party Ready",
                            Content = "üéØ Quay l·∫°i dungeon...",
                            Duration = 5
                        })
                        task.wait(3)
                        SharedJobIdSystem:TeleportToPlace(dungeonData.PlaceId, dungeonData.JobId)
                        return
                    end
                end
            else
                warn("‚ö†Ô∏è Party thi·∫øu", expectedTotal - onlineCount, "ng∆∞·ªùi")
                
                -- ‚úÖ MEMBER: X·ª¨ L√ù REJOIN
                if not isLeader() then
                    if aC then
                        warn("üè∞ [MEMBER IN DUNGEON] Thi·∫øu ng∆∞·ªùi!")
                        ao.PartyRejoinDungeon = true
                        ao.PartyDungeonJobId = game.JobId
                        ao.PartyDungeonPlaceId = game.PlaceId
                        ao.PartyDungeonId = ay
                        ao.PartyDifficulty = az
                        ao.PartyTimestamp = tick()
                        savePartyData()
                        
                        task.wait(3)
                        
                        reloadSharedRejoinJobId()
                        task.wait(0.5)
                        
                        if PartyGlobals.SharedRejoinJobId then
                            SharedJobIdSystem:TeleportToPlace(PartyGlobals.SharedRejoinPlaceId, PartyGlobals.SharedRejoinJobId)
                            return
                        end
                    else
                        reloadSharedRejoinJobId()
                        task.wait(0.5)
                        
                        if PartyGlobals.SharedRejoinJobId then
                            local currentJobId = game.JobId
                            local expectedJobId = PartyGlobals.SharedRejoinJobId
                            
                            if currentJobId ~= expectedJobId then
                                warn("‚ùå SAI JOBID! Rejoin...")
                                SharedJobIdSystem:TeleportToPlace(PartyGlobals.SharedRejoinPlaceId, expectedJobId)
                                return
                            end
                        end
                    end
                end
                
                local missingMembers = getMissingMembers()
                local onlineMissingCount = 0
                local offlineMissingCount = 0
                
                for _, memberName in ipairs(missingMembers) do
                    if game:GetService("Players"):FindFirstChild(memberName) then
                        onlineMissingCount = onlineMissingCount + 1
                    else
                        offlineMissingCount = offlineMissingCount + 1
                    end
                end
                
                -- ‚úÖ C√ì NG∆Ø·ªúI DISCONNECT ‚Üí REJOIN
                if offlineMissingCount > 0 then
                    warn("üî¥", offlineMissingCount, "ng∆∞·ªùi disconnect")
                    
                    if aC then
                        ao.PartyRejoinDungeon = true
                        ao.PartyDungeonJobId = game.JobId
                        ao.PartyDungeonPlaceId = game.PlaceId
                        ao.PartyDungeonId = ay
                        ao.PartyDifficulty = az
                        ao.PartyTimestamp = tick()
                        savePartyData()
                    end
                    
                    task.wait(5)
                    
                    local stillOffline = 0
                    for _, memberName in ipairs(missingMembers) do
                        if not game:GetService("Players"):FindFirstChild(memberName) then
                            stillOffline = stillOffline + 1
                        end
                    end
                    
                    if stillOffline > 0 then
                        warn("üîÑ X√°c nh·∫≠n disconnect ‚Üí Rejoin")
                        
                        local targetPlaceId = 7499964980
                        local targetJobId
                        
                        reloadSharedRejoinJobId()
                        task.wait(0.5)
                        
                        if PartyGlobals.SharedRejoinJobId then
                            targetJobId = PartyGlobals.SharedRejoinJobId
                        else
                            if isLeader() then
                                targetJobId = SharedJobIdSystem:GetMarketplaceJobIdFromAPI()
                                if targetJobId then
                                    saveSharedRejoinJobId(targetPlaceId, targetJobId)
                                    task.wait(3)
                                end
                            else
                                for retry = 1, 5 do
                                    task.wait(8)
                                    if reloadSharedRejoinJobId() then
                                        targetJobId = PartyGlobals.SharedRejoinJobId
                                        break
                                    end
                                end
                            end
                        end
                        
                        if targetJobId then
                            if game.JobId ~= targetJobId or game.PlaceId ~= targetPlaceId then
                                WindUI:Notify({
                                    Title = isLeader() and "Member Disconnected" or "Rejoining",
                                    Content = "üîÑ Rejoin Marketplace...",
                                    Duration = 5
                                })
                                task.wait(2)
                                SharedJobIdSystem:TeleportToPlace(targetPlaceId, targetJobId)
                                return
                            end
                        end
                    end
                end
                
                -- ‚úÖ NG∆Ø·ªúI ONLINE CH∆ØA V√ÄO PARTY + ·ªû MARKETPLACE
                if onlineMissingCount > 0 and isInMarketplace() then
                    warn("üë• Ng∆∞·ªùi online c√πng server ‚Üí M·ªùi/Accept")
                    
                    if not isLeader() then
                        local myPartyId = getMyPartyId()
                        if myPartyId then
                            local leaderName = PartyGlobals.PartySetup.Leader
                            if not isInParty(leaderName) then
                                warn("‚ö†Ô∏è Party sai ‚Üí R·ªùi")
                                pcall(function()
                                    game:GetService("ReplicatedStorage"):WaitForChild("Shared"):WaitForChild("Party"):WaitForChild("LeaveParty"):InvokeServer()
                                    task.wait(2)
                                end)
                            end
                        end
                        
                        reloadSharedRejoinJobId()
                        task.wait(0.5)
                        
                        if PartyGlobals.SharedRejoinJobId and game.JobId ~= PartyGlobals.SharedRejoinJobId then
                            SharedJobIdSystem:TeleportToPlace(PartyGlobals.SharedRejoinPlaceId, PartyGlobals.SharedRejoinJobId)
                            return
                        end
                    end
                    
                    if isLeader() then
                        for _, memberName in ipairs(missingMembers) do
                            if game:GetService("Players"):FindFirstChild(memberName) then
                                inviteMember(memberName)
                                task.wait(2)
                            end
                        end
                    end
                    
                    if not isLeader() then
                        local leaderName = PartyGlobals.PartySetup.Leader
                        if game:GetService("Players"):FindFirstChild(leaderName) then
                            acceptInvite(leaderName)
                        end
                    end
                    
                    rejoinAttempts = 0
                end
                
                -- ‚úÖ NG∆Ø·ªúI ONLINE KH√ÅC SERVER
                if onlineMissingCount > 0 and not isInMarketplace() then
                    local timeSinceLastRejoin = tick() - lastRejoinTime
                    
                    if timeSinceLastRejoin >= 60 and rejoinAttempts < 5 then
                        warn("üîÑ Kh√°c server ‚Üí Rejoin")
                        rejoinAttempts = rejoinAttempts + 1
                        lastRejoinTime = tick()
                        
                        local targetPlaceId = 7499964980
                        local targetJobId
                        
                        reloadSharedRejoinJobId()
                        task.wait(0.5)
                        
                        if PartyGlobals.SharedRejoinJobId then
                            targetJobId = PartyGlobals.SharedRejoinJobId
                        else
                            if isLeader() then
                                targetJobId = SharedJobIdSystem:GetMarketplaceJobIdFromAPI()
                                if targetJobId then
                                    saveSharedRejoinJobId(targetPlaceId, targetJobId)
                                    task.wait(2)
                                end
                            else
                                for retry = 1, 2 do
                                    task.wait(10)
                                    if reloadSharedRejoinJobId() then
                                        targetJobId = PartyGlobals.SharedRejoinJobId
                                        break
                                    end
                                end
                            end
                        end
                        
                        if targetJobId then
                            if game.JobId ~= targetJobId or game.PlaceId ~= targetPlaceId then
                                WindUI:Notify({
                                    Title = "Gathering Party",
                                    Content = "üîÑ Rejoin Marketplace...",
                                    Duration = 5
                                })
                                task.wait(2)
                                SharedJobIdSystem:TeleportToPlace(targetPlaceId, targetJobId)
                                return
                            else
                                rejoinAttempts = 0
                            end
                        end
                    end
                end
            end
            
            task.wait(PartyGlobals.PartyCheckDelay)
        end
        PartyGlobals.isMonitoringParty = false
    end)
end

-- ==================== CONFIG FUNCTIONS ====================
local function savePartyConfig()
    if not writefile or PartyGlobals.isLoadingPartyConfig then return end
    local data = {
        Leader = PartyGlobals.PartySetup.Leader,
        Members = PartyGlobals.PartySetup.Members
    }
    writefile(PartyGlobals.PartyConfigFile, e:JSONEncode(data))
end

local function loadPartyConfig()
    if not isfile or not isfile(PartyGlobals.PartyConfigFile) then return false end
    
    PartyGlobals.isLoadingPartyConfig = true
    
    local success = pcall(function()
        local content = readfile(PartyGlobals.PartyConfigFile)
        local data = e:JSONDecode(content)
        
        if data then
            PartyGlobals.PartySetup.Leader = data.Leader or ""
            for i = 1, 5 do
                PartyGlobals.PartySetup.Members[i] = (data.Members and data.Members[i]) or ""
            end
            task.delay(0.1, function()
                PartyGlobals.isLoadingPartyConfig = false
            end)
            return true
        end
    end)
    
    if not success then
        PartyGlobals.isLoadingPartyConfig = false
    end
    return success
end

-- ==================== UI CREATION ====================
local function createRejoinSystemUI(TabParty)
    TabParty:Divider({ Text = "üîÑ Auto Rejoin System (API)" })
    
    local jobIdPara = TabParty:Paragraph({
        Title = "üìç Marketplace JobId (API)",
        Description = "Loading..."
    })
    
    local rejoinStatusPara = TabParty:Paragraph({
        Title = "üîÑ Rejoin Status",
        Description = "Disabled"
    })
    
    task.spawn(function()
        while task.wait(5) do
            pcall(function()
                local savedRejoin = loadSharedRejoinJobId()
                local desc = "No shared JobId"
                
                if savedRejoin and savedRejoin.JobId then
                    local age = math.floor(tick() - savedRejoin.Timestamp)
                    desc = "Marketplace JobId (API):\n  " .. savedRejoin.JobId:sub(1, 25) .. "..."
                    desc = desc .. "\n  Age: " .. timeElapsed(age)
                    desc = desc .. "\n  PlaceId: 7499964980"
                end
                
                jobIdPara:SetDesc(desc)
            end)
        end
    end)
    
    ConfigSystem.registerUIElement("AutoRejoin", TabParty:Toggle({
        Title = "Auto Rejoin on Disconnect",
        Description = "T·ª± ƒë·ªông rejoin Marketplace + reform party",
        Default = ToggleStates.AutoRejoin or false,
        Callback = function(s)
            if Toggles.AutoRejoin then
                Toggles.AutoRejoin:SetValue(s)
            end
            rejoinStatusPara:SetDesc(s and "‚úÖ Enabled" or "‚ùå Disabled")
        end
    }))
    
    TabParty:Button({
        Title = "üîÑ Test API JobId",
        Description = "L·∫•y JobId m·ªõi t·ª´ API",
        Callback = function()
            local jobId = SharedJobIdSystem:GetMarketplaceJobIdFromAPI()
            if jobId then
                WindUI:Notify({
                    Title = "API JobId",
                    Content = "‚úÖ " .. jobId:sub(1, 20) .. "...",
                    Duration = 5
                })
            else
                WindUI:Notify({
                    Title = "API Error",
                    Content = "‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c JobId",
                    Duration = 3
                })
            end
        end
    })
    
    TabParty:Button({
        Title = "üóëÔ∏è Clear Shared JobId",
        Description = "X√≥a JobId chung",
        Callback = function()
            if writefile then
                pcall(function()
                    writefile(PartyGlobals.SharedRejoinFile, "")
                    PartyGlobals.SharedRejoinJobId = nil
                    PartyGlobals.SharedRejoinPlaceId = nil
                end)
            end
            WindUI:Notify({
                Title = "JobId",
                Content = "üóëÔ∏è ƒê√£ x√≥a",
                Duration = 2
            })
        end
    })
end

local function createAutoPartyTab()
    local TabParty = Window:Tab({
        Title = "Auto Party",
        Icon = "users",
        Locked = false,
    })
    
    _G.loadPartyConfigGlobal = loadPartyConfig
    _G.PartySetup = PartyGlobals.PartySetup
    
    local rolePara = TabParty:Paragraph({
        Title = "üé≠ My Role",
        Description = "Not configured"
    })
    
    local statusPara = TabParty:Paragraph({
        Title = "Current Party",
        Description = "Not configured"
    })
    
    local function updateStatus()
        local roleText = ""
        if PartyGlobals.PartySetup.Leader == c.Name then
            roleText = "üëë LEADER"
        elseif PartyGlobals.PartySetup.Leader ~= "" then
            roleText = "üë§ MEMBER\nLeader: " .. PartyGlobals.PartySetup.Leader
        else
            roleText = "‚ö†Ô∏è Not configured"
        end
        rolePara:SetDesc(roleText)
        
        local s = ""
        if PartyGlobals.PartySetup.Leader ~= "" then
            local leaderInGame = game:GetService("Players"):FindFirstChild(PartyGlobals.PartySetup.Leader)
            local isYou = PartyGlobals.PartySetup.Leader == c.Name and " (You)" or ""
            s = s .. (leaderInGame and "‚úÖ" or "‚ùå") .. " Leader: " .. PartyGlobals.PartySetup.Leader .. isYou .. "\n"
        end
        
        for i, m in ipairs(PartyGlobals.PartySetup.Members) do
            if m ~= "" then
                local memberInGame = game:GetService("Players"):FindFirstChild(m)
                local inPartyStatus = isInParty(m) and "üü¢" or "‚ö™"
                local isYou = m == c.Name and " (You)" or ""
                s = s .. (memberInGame and "‚úÖ" or "‚ùå") .. inPartyStatus .. " M" .. i .. ": " .. m .. isYou .. "\n"
            end
        end
        
        local currentCount = getCurrentPartyMemberCount()
        local expectedCount = getExpectedPartySize()
        s = s .. "\nüìä Party: " .. currentCount .. "/" .. expectedCount .. " members"
        
        statusPara:SetDesc(s ~= "" and s or "Not configured")
    end
    
    _G.updatePartyStatus = updateStatus
    
    TabParty:Divider({ Text = "Party Setup" })
    
    local function getPlayersListWithNone()
        local list = {"-- None --"}
        for _, name in ipairs(getPlayersList()) do
            table.insert(list, name)
        end
        return list
    end
    
    TabParty:Dropdown({
        Title = "Party Leader",
        Description = "Ch·ªçn leader",
        Values = getPlayersListWithNone(),
        Multi = false,
        Callback = function(v)
            if PartyGlobals.isInitializingUI then return end
            PartyGlobals.PartySetup.Leader = (v == "-- None --" or not v) and "" or v
            updateStatus()
            savePartyConfig()
        end
    })
    
    for i = 1, 5 do
        TabParty:Dropdown({
            Title = "Member " .. i,
            Description = "Ch·ªçn member",
            Values = getPlayersListWithNone(),
            Multi = false,
            Callback = function(v)
                if PartyGlobals.isInitializingUI then return end
                PartyGlobals.PartySetup.Members[i] = (v == "-- None --" or not v) and "" or v
                updateStatus()
                savePartyConfig()
            end
        })
    end
    
    task.spawn(function()
        task.wait(1)
        local loaded = loadPartyConfig()
        task.wait(0.5)
        PartyGlobals.isInitializingUI = false
        if loaded then
            updateStatus()
            WindUI:Notify({
                Title = "Party Config",
                Content = "‚úÖ Loaded",
                Duration = 3
            })
        end
    end)
    
    TabParty:Divider({ Text = "Actions" })
    
    TabParty:Button({
        Title = "Refresh Status",
        Description = "C·∫≠p nh·∫≠t",
        Callback = function()
            updateStatus()
            WindUI:Notify({ Title = "Success", Content = "Refreshed!", Duration = 2 })
        end
    })
    
    TabParty:Button({
        Title = "Save Party Config",
        Description = "L∆∞u setup",
        Callback = function()
            savePartyConfig()
            WindUI:Notify({ Title = "Success", Content = "‚úÖ ƒê√£ l∆∞u!", Duration = 3 })
        end
    })
    
    TabParty:Divider({ Text = "Automation" })
    
    ConfigSystem.registerUIElement("AutoInviteAll", TabParty:Toggle({
        Title = "Auto Invite All",
        Description = "T·ª± ƒë·ªông m·ªùi (Leader only)",
        Default = ToggleStates.AutoInviteAll or false,
        Callback = function(s)
            if Toggles.AutoInviteAll then
                Toggles.AutoInviteAll:SetValue(s)
            end
            if s then
                task.spawn(function()
                    while Toggles.AutoInviteAll and Toggles.AutoInviteAll.Value do
                        if isLeader() then
                            for _, n in ipairs(getMembersToInvite()) do
                                if not isInParty(n) then
                                    inviteMember(n)
                                    task.wait(3)
                                end
                            end
                        end
                        task.wait(25)
                    end
                end)
            end
        end
    }))
    
    createRejoinSystemUI(TabParty)
    
    TabParty:Divider({ Text = "Party Control" })
    
    ConfigSystem.registerUIElement("AutoAcceptInvite", TabParty:Toggle({
        Title = "Auto Accept Invite",
        Description = "T·ª± ƒë·ªông accept (Member only)",
        Default = ToggleStates.AutoAcceptInvite or false,
        Callback = function(s)
            if Toggles.AutoAcceptInvite then
                Toggles.AutoAcceptInvite:SetValue(s)
            end
            if s then
                task.spawn(function()
                    while Toggles.AutoAcceptInvite and Toggles.AutoAcceptInvite.Value do
                        if not isLeader() then
                            pcall(function()
                                local leaderPlayer = game:GetService("Players"):FindFirstChild(PartyGlobals.PartySetup.Leader)
                                if leaderPlayer and not getMyPartyId() then
                                    acceptInvite(PartyGlobals.PartySetup.Leader)
                                    task.wait(2)
                                end
                            end)
                        end
                        task.wait(3)
                    end
                end)
            end
        end
    }))
    
    ConfigSystem.registerUIElement("AutoPartyMonitor", TabParty:Toggle({
        Title = "Auto Monitor Party",
        Description = "Rejoin v·ªÅ Marketplace (API JobId) + auto reform",
        Default = ToggleStates.AutoPartyMonitor or false,
        Callback = function(s)
            if Toggles.AutoPartyMonitor then
                Toggles.AutoPartyMonitor:SetValue(s)
            end
            if s then
                startPartyMonitoring()
            end
        end
    }))
    
    task.spawn(function()
        while task.wait(3) do
            updateStatus()
        end
    end)
end

-- ==================== INIT MODULE ====================
function Module:Init()
    SharedJobIdSystem:StartMonitoring()
    createAutoPartyTab()
    warn("‚úÖ Auto Party Module loaded (Marketplace API version)!")
end

return Module
